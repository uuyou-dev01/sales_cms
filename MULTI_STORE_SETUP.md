# 多店铺管理系统设置指南

## 概述

本系统现在支持多店铺管理，每个店铺都有独立的数据和用户。现有的所有数据将自动迁移到"店铺A"。

## 系统架构

### 数据库模型
- **Store**: 店铺信息
- **User**: 用户账户（关联到特定店铺）
- **Item**: 商品（关联到特定店铺）
- **Transaction**: 交易记录（关联到特定店铺）
- **Warehouse**: 仓库（关联到特定店铺）

### 用户角色
- **ADMIN**: 店铺管理员，拥有所有权限
- **USER**: 普通用户，可以管理商品和交易
- **VIEWER**: 只读用户，只能查看数据

## 安装步骤

### 1. 更新数据库架构
```bash
# 推送新的数据库架构
npx prisma db push

# 生成Prisma客户端
npx prisma generate
```

### 2. 初始化数据库
```bash
# 创建默认店铺和用户
npx tsx scripts/init-database.ts
```

### 3. 迁移现有数据
```bash
# 将现有数据迁移到店铺A
npx tsx scripts/migrate-existing-data.ts
```

## 默认账户

### 店铺A（包含现有数据）
- **管理员**: `admin` / `admin123`
- **普通用户**: `user_a` / `user123`

### 店铺B（新店铺）
- **管理员**: `storeb` / `storeb123`
- **普通用户**: `user_b` / `user123`

## 功能特性

### 多店铺隔离
- 每个店铺的数据完全独立
- 用户只能访问自己店铺的数据
- 店铺间数据不共享

### 认证系统
- 基于Cookie的会话管理
- JWT token用于API调用
- 自动重定向未认证用户

### 权限控制
- 基于角色的访问控制
- 店铺级别的数据隔离
- 细粒度的功能权限

## 使用方法

### 登录系统
1. 访问 `/login` 页面
2. 输入用户名和密码
3. 选择要登录的店铺账户
4. 系统自动重定向到销售页面

### 切换店铺
- 登出当前账户
- 使用其他店铺的账户登录
- 系统自动显示对应店铺的数据

### 数据管理
- 每个店铺独立管理商品、交易、仓库
- 批量导入功能支持店铺隔离
- 统计报表按店铺显示

## 安全特性

### 数据隔离
- 数据库级别的店铺隔离
- API级别的权限验证
- 前端路由保护

### 会话管理
- 7天会话有效期
- 自动过期处理
- 安全的Cookie设置

## 开发说明

### 添加新店铺
1. 在数据库中创建新的Store记录
2. 创建对应的用户账户
3. 设置店铺特定的配置

### 自定义权限
- 修改 `UserRole` 枚举
- 更新权限检查逻辑
- 调整UI显示

### API开发
- 所有API都需要店铺ID
- 使用中间件验证权限
- 返回店铺相关的数据

## 故障排除

### 常见问题

#### 1. 登录失败
- 检查用户名和密码
- 确认账户未被禁用
- 验证店铺状态

#### 2. 数据不显示
- 确认用户已登录
- 检查店铺ID关联
- 验证数据迁移状态

#### 3. 权限错误
- 检查用户角色
- 确认店铺访问权限
- 验证API调用权限

### 调试工具
- 使用 `/test-clear-db` 清除缓存
- 检查浏览器控制台错误
- 查看服务器日志

## 部署注意事项

### 生产环境
- 使用HTTPS
- 配置安全的Cookie设置
- 启用数据库连接池
- 设置适当的日志级别

### 性能优化
- 数据库索引优化
- API响应缓存
- 前端资源压缩
- CDN配置

## 更新日志

### v1.0.0 - 多店铺系统
- 新增多店铺支持
- 实现用户认证系统
- 数据隔离和权限控制
- 现有数据自动迁移

## 技术支持

如有问题，请检查：
1. 数据库连接状态
2. 用户认证状态
3. 店铺数据关联
4. 权限配置设置
